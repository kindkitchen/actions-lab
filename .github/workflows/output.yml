name: Generate .env and pass it to another job

on:
  push:
  workflow_dispatch:

jobs:
  compute_dotenv_content:
    environment: lab
    runs-on: ubuntu-latest
    outputs:
      dotenv_content: ${{ steps.step1.outputs.CONTENT }}
    steps:
     - name: Generate dotenv file
       id: step1
       env:
        SECRET_CONTENT: ${{ toJson(secrets) }}
        VARS_CONTENT: ${{ toJson(vars) }}
       run: |
        echo $VARS_CONTENT > vars_content.json 
        cat vars_content.json | jq -r 'to_entries | map(select(.key | test("[A-Z_]+"))) | .[] | "\(.key)=\(.value | @json)\n"' > output.txt
        CONTENT=$(jq -Rs . < output.txt)
        echo "CONTENT=$CONTENT"
        echo "CONTENT=$CONTENT" >> "$GITHUB_OUTPUT"
        
      # echo $SECRET_CONTENT > secrets_content.json 
      # cat secrets_content.json | jq -r 'to_entries | map(select(.key | test("[A-Z_]+"))) | .[] | "\(.key)=\(.value | @json)\n"' >> output.txt
  display_dotenv_content:
    runs-on: ubuntu-latest
    needs: compute_dotenv_content
    steps:
      - name: Display dotenv file
        env:
          DOTENV_CONTENT: ${{ needs.compute_dotenv_content.outputs.dotenv_content }}
        run: |
          echo $DOTENV_CONTENT
        # echo ${{ env.DOTENV_CONTENT }}
